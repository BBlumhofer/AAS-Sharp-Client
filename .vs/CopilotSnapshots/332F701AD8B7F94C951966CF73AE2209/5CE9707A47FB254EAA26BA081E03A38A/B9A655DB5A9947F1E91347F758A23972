using System.Collections.Generic;
using System.Threading.Tasks;
using BaSyx.Models.AdminShell;
using BaSyx.Models.Extensions;
using AasSharpClient.Adapters;
using AasSharpClient.Tools;
using System.Text.Json;
using BaSyx.Utils.Client.Http;
using BaSyx.Utils.DependencyInjection;
using BaSyx.Utils;

namespace AasSharpClient.Models
{
    // Generated POCO for ProductionPlan submodel using BaSyx models
    public partial class ProductionPlan
    {
        public ISubmodelElementCollection Content { get; set; } = new SubmodelElementCollection("ProductionPlan");

        public IProperty IsFinished => BasyxBrowser.FindProperty(Content, "IsFinished");

        public List<Step> Steps { get; set; } = new();

        [System.Text.Json.Serialization.JsonIgnore]
        public IBasyxAdapter? Adapter { get; set; }

        public ProductionPlan() { }

        // Domain-friendly constructor used by tests
        public ProductionPlan(bool isFinished, int totalPieces, Step initialStep)
        {
            Content = new SubmodelElementCollection("ProductionPlan");
            Content.Value.Value.Add(new Property<string>("IsFinished", isFinished.ToString()));
            Content.Value.Value.Add(new SubmodelElementCollection("Steps") { Value = { Value = { initialStep.Content } } });
            Steps.Add(initialStep);
        }

        public async Task<bool> IsFinishedAsync()
        {
            var val = await BasyxBrowser.GetPropertyValueAsStringAsync(IsFinished).ConfigureAwait(false);
            return bool.TryParse(val, out var v);
        }

        public async Task CompleteAsync()
        {
            await BasyxBrowser.SetPropertyValueAsync(IsFinished, "true").ConfigureAwait(false);
            if (Adapter != null)
            {
                await Adapter.UploadPropertyAsync(this.Content, IsFinished.IdShort, "true").ConfigureAwait(false);
            }
        }

        public async Task UploadStepAsync(Step step)
        {
            if (Adapter != null)
            {
                await Adapter.UploadElementAsync(step.Content).ConfigureAwait(false);
            }
        }

        public void append_step(Step step)
        {
            // add to inner Steps collection and to Steps list
            var stepsColl = BasyxBrowser.FindProperty(Content, "Steps");
            // if Steps not found create it
            var coll = new SubmodelElementCollection("Steps");
            coll.Value.Value.Add(step.Content);
            Content.Value.Value.Add(coll);
            Steps.Add(step);
        }

        public string ToJsonAsync()
        {
            // Build a simple anonymous model that mirrors expected JSON
            var model = new
            {
                idShort = Content.IdShort,
                submodelElements = new object[]
                {
                    new { idShort = "IsFinished", type = "Property", value = BasyxBrowser.GetPropertyValueAsStringAsync(IsFinished).GetAwaiter().GetResult() },
                    new { idShort = "Steps", type = "SubmodelElementCollection", value = new object[] {
                        new { idShort = Steps[0].Content.IdShort, type = "SubmodelElementCollection", value = new object[] {
                            new { idShort = "StepTitle", type = "Property", value = BasyxBrowser.GetPropertyValueAsStringAsync(Steps[0].StepTitle).GetAwaiter().GetResult() },
                            new { idShort = "Status", type = "Property", value = BasyxBrowser.GetPropertyValueAsStringAsync(Steps[0].Status).GetAwaiter().GetResult() }
                        } }
                    } }
                }
            };

            var options = new JsonSerializerOptions { WriteIndented = true };
            return JsonSerializer.Serialize(model, options);
        }

        public static ProductionPlan Parse(string json)
        {
            // very small parser for the tests: parse JSON and reconstruct ProductionPlan
            var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;
            var elements = root.GetProperty("submodelElements").EnumerateArray();
            var isFinished = false;
            Step firstStep = null;
            foreach (var el in elements)
            {
                var id = el.GetProperty("idShort").GetString();
                if (id == "IsFinished")
                {
                    var val = el.GetProperty("value").GetString();
                    isFinished = bool.TryParse(val, out var v) && v;
                }
                if (id == "Steps")
                {
                    var stepsArr = el.GetProperty("value").EnumerateArray();
                    foreach (var s in stepsArr)
                    {
                        var stepElems = s.GetProperty("value").EnumerateArray();
                        var title = stepElems.First(x => x.GetProperty("idShort").GetString() == "StepTitle").GetProperty("value").GetString();
                        var status = stepElems.First(x => x.GetProperty("idShort").GetString() == "Status").GetProperty("value").GetString();
                        var action = new Action("Action0001", "Imported", ActionStatusEnum.OPEN, new InputParameters(new Dictionary<string,string>()), new FinalResultData(), new SkillReference(new Dictionary<object,string>()), "");
                        firstStep = new Step("Step0001", title, status == "DONE" ? StepStatusEnum.DONE : StepStatusEnum.OPEN, action, "", null, "", "");
                    }
                }
            }

            return new ProductionPlan(isFinished ? true : false, 0, firstStep);
        }
    }
}
