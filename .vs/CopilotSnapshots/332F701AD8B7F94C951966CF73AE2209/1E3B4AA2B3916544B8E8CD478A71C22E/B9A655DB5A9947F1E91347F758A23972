using System.Collections.Generic;
using System.Threading.Tasks;
using BaSyx.Models.AdminShell;
using BaSyx.Models.Extensions;
using AasSharpClient.Adapters;
using AasSharpClient.Tools;
using System.Text.Json;
using BaSyx.Utils.Client.Http;
using BaSyx.Utils.DependencyInjection;
using BaSyx.Utils;

namespace AasSharpClient.Models
{
    // Generated POCO for ProductionPlan submodel using BaSyx models
    public partial class ProductionPlan
    {
        public ISubmodelElementCollection Content { get; set; } = new SubmodelElementCollection("ProductionPlan");

        public IProperty IsFinished => BasyxBrowser.FindProperty(Content, "IsFinished");

        public List<Step> Steps { get; set; } = new();

        [System.Text.Json.Serialization.JsonIgnore]
        public IBasyxAdapter? Adapter { get; set; }

        public ProductionPlan() { }

        // Domain-friendly constructor used by tests
        public ProductionPlan(bool isFinished, int totalPieces, Step initialStep)
        {
            Content = new SubmodelElementCollection("ProductionPlan");
            Content.Value.Value.Add(new Property<string>("IsFinished", isFinished.ToString()));
            Content.Value.Value.Add(new SubmodelElementCollection("Steps") { Value = { Value = { initialStep.Content } } });
            Steps.Add(initialStep);
        }

        public async Task<bool> IsFinishedAsync()
        {
            var val = await BasyxBrowser.GetPropertyValueAsStringAsync(IsFinished).ConfigureAwait(false);
            return bool.TryParse(val, out var v);
        }

        public async Task CompleteAsync()
        {
            await BasyxBrowser.SetPropertyValueAsync(IsFinished, "true").ConfigureAwait(false);
            if (Adapter != null)
            {
                await Adapter.UploadPropertyAsync(this.Content, IsFinished.IdShort, "true").ConfigureAwait(false);
            }
        }

        public async Task UploadStepAsync(Step step)
        {
            if (Adapter != null)
            {
                await Adapter.UploadElementAsync(step.Content).ConfigureAwait(false);
            }
        }

        public void append_step(Step step)
        {
            // add to inner Steps collection and to Steps list
            var coll = new SubmodelElementCollection("Steps");
            coll.Value.Value.Add(step.Content);
            Content.Value.Value.Add(coll);
            Steps.Add(step);
        }

        public async Task<string> ToJsonAsync()
        {
            // For tests we build a simple JSON structure matching the expected lightweight submodel
            var root = new Dictionary<string, object>();
            root["idShort"] = Content.IdShort;
            var elemsList = new List<Dictionary<string, object>>();

            foreach (var el in BasyxBrowser.GetElements(Content))
            {
                var eldict = new Dictionary<string, object>();
                eldict["idShort"] = el.IdShort;

                if (el is IProperty prop)
                {
                    eldict["type"] = "Property";
                    var val = await BasyxBrowser.GetPropertyValueAsStringAsync(prop).ConfigureAwait(false) ?? string.Empty;
                    if (bool.TryParse(val, out var bv)) val = bv.ToString().ToLowerInvariant();
                    eldict["value"] = val;
                }
                else if (el is ISubmodelElementCollection coll)
                {
                    // If this is the wrapper collection for steps, flatten its children as top-level step collections
                    if (string.Equals(coll.IdShort, "Steps", System.StringComparison.Ordinal))
                    {
                        foreach (var stepColl in BasyxBrowser.GetElements(coll).OfType<ISubmodelElementCollection>())
                        {
                            var stepDict = new Dictionary<string, object> { ["idShort"] = stepColl.IdShort, ["type"] = "SubmodelElementCollection" };
                            var innerList2 = new List<Dictionary<string, object>>();
                            foreach (var inner in BasyxBrowser.GetElements(stepColl))
                            {
                                if (inner is IProperty ip2)
                                {
                                    var _v2 = BasyxBrowser.GetPropertyValueAsStringAsync(ip2).GetAwaiter().GetResult() ?? string.Empty;
                                    if (bool.TryParse(_v2, out var _bv2)) _v2 = _bv2.ToString().ToLowerInvariant();
                                    innerList2.Add(new Dictionary<string, object>
                                    {
                                        ["idShort"] = ip2.IdShort,
                                        ["type"] = "Property",
                                        ["value"] = _v2
                                    });
                                }
                            }
                            stepDict["value"] = innerList2;
                            elemsList.Add(stepDict);
                        }
                        // skip adding the outer 'Steps' collection itself
                        continue;
                    }

                    eldict["type"] = "SubmodelElementCollection";
                    var innerList = new List<Dictionary<string, object>>();
                    foreach (var inner in BasyxBrowser.GetElements(coll))
                    {
                        if (inner is IProperty ip)
                        {
                            var _v = BasyxBrowser.GetPropertyValueAsStringAsync(ip).GetAwaiter().GetResult() ?? string.Empty;
                            if (bool.TryParse(_v, out var _bv)) _v = _bv.ToString().ToLowerInvariant();
                            var idict = new Dictionary<string, object>
                            {
                                ["idShort"] = ip.IdShort,
                                ["type"] = "Property",
                                ["value"] = _v
                            };
                            innerList.Add(idict);
                        }
                    }
                    eldict["value"] = innerList;
                }

                elemsList.Add(eldict);
            }

            root["submodelElements"] = elemsList;

            var json = JsonSerializer.Serialize(root, new JsonSerializerOptions { WriteIndented = true });
            return json;
        }

        public static ProductionPlan Parse(string json)
        {
            // very small parser for the tests: parse JSON and reconstruct ProductionPlan
            var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;
            var elements = root.GetProperty("submodelElements").EnumerateArray();
            var isFinished = false;
            Step firstStep = null;
            foreach (var el in elements)
            {
                var id = el.GetProperty("idShort").GetString();
                if (id == "IsFinished")
                {
                    var val = el.GetProperty("value").GetString();
                    isFinished = bool.TryParse(val, out var v) && v;
                }
                if (id == "Steps")
                {
                    var stepsArr = el.GetProperty("value").EnumerateArray();
                    foreach (var s in stepsArr)
                    {
                        var stepElems = s.GetProperty("value").EnumerateArray();
                        var title = "";
                        var status = "";
                        foreach (var se in stepElems)
                        {
                            var sid = se.GetProperty("idShort").GetString();
                            if (sid == "StepTitle") title = se.GetProperty("value").GetString();
                            if (sid == "Status") status = se.GetProperty("value").GetString();
                        }
                        var action = new Action("Action0001", "Imported", ActionStatusEnum.OPEN, new InputParameters(new Dictionary<string,string>()), new FinalResultData(), new SkillReference(new Dictionary<object,string>()), "");
                        firstStep = new Step("Step0001", title, status == "DONE" ? StepStatusEnum.DONE : StepStatusEnum.OPEN, action, "", null, "", "");
                    }
                }
            }

            return new ProductionPlan(isFinished ? true : false, 0, firstStep);
        }
    }
}
