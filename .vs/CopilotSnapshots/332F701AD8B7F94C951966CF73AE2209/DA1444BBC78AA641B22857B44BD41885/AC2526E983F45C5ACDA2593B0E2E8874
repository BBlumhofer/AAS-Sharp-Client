using System;
using System.Reflection;
using System.Threading.Tasks;
using BaSyx.API.Clients;
using AasSharpClient.Adapters;

namespace AasSharpClient.Adapters
{
    // Adapter that delegates operations to BaSyx ISubmodelClient / IAssetAdministrationShellClient
    // using reflection for certain value wrapper types to remain resilient to minor API shape differences.
    public class BasyxAdapter : IBasyxAdapter
    {
        private readonly ISubmodelClient _submodelClient;
        private readonly IAssetAdministrationShellClient? _aasClient;

        public BasyxAdapter(ISubmodelClient submodelClient, IAssetAdministrationShellClient? aasClient = null)
        {
            _submodelClient = submodelClient ?? throw new ArgumentNullException(nameof(submodelClient));
            _aasClient = aasClient;
        }

        public async Task UploadPropertyAsync<T>(object parent, string propertyName, T value)
        {
            if (parent == null) throw new ArgumentNullException(nameof(parent));

            // parent is expected to be an ISubmodelElement or a path string
            string idShortPath = propertyName;
            if (parent is string path && !string.IsNullOrEmpty(path))
                idShortPath = path + "/" + propertyName;
            else
            {
                try
                {
                    var idShortProp = parent.GetType().GetProperty("IdShort");
                    var parentId = idShortProp?.GetValue(parent) as string ?? ".";
                    idShortPath = parentId == "." ? propertyName : parentId + "/" + propertyName;
                }
                catch { }
            }

            // Build Invocation of UpdateSubmodelElementValueAsync
            var clientType = _submodelClient.GetType();
            var method = clientType.GetMethod("UpdateSubmodelElementValueAsync", BindingFlags.Public | BindingFlags.Instance);
            if (method == null) throw new NotSupportedException("ISubmodelClient.UpdateSubmodelElementValueAsync not found");

            // Build ValueScope instance via reflection
            Type? valueScopeType = Type.GetType("BaSyx.Models.AdminShell.ValueScope, BaSyx.Models")
                ?? Type.GetType("BaSyx.Models.AdminShell.ValueScope, BaSyx.Models.AdminShell");

            object? valueScope = null;
            if (valueScopeType != null)
            {
                valueScope = Activator.CreateInstance(valueScopeType);
                var prop = valueScopeType.GetProperty("Value");
                if (prop != null)
                {
                    if (prop.PropertyType == typeof(string))
                        prop.SetValue(valueScope, value?.ToString());
                    else if (prop.PropertyType.IsAssignableFrom(value?.GetType()))
                        prop.SetValue(valueScope, value);
                }
            }

            var taskObj = method.Invoke(_submodelClient, new object[] { idShortPath, valueScope ?? (object)value });
            if (taskObj is Task task)
            {
                await task.ConfigureAwait(false);
            }
        }

        public async Task UploadElementAsync(object element)
        {
            if (element == null) throw new ArgumentNullException(nameof(element));

            var clientType = _submodelClient.GetType();

            MethodInfo? method = clientType.GetMethod("UpdateSubmodelElementAsync", new Type[] { typeof(string), element.GetType() });
            if (method == null)
                method = clientType.GetMethod("UpdateSubmodelElementAsync", new Type[] { typeof(string), typeof(object) });

            if (method != null)
            {
                var task = (Task)method.Invoke(_submodelClient, new object[] { ".", element })!;
                await task.ConfigureAwait(false);
                return;
            }

            method = clientType.GetMethod("CreateSubmodelElementAsync", new Type[] { typeof(string), typeof(object) });
            if (method != null)
            {
                var task = (Task)method.Invoke(_submodelClient, new object[] { ".", element })!;
                await task.ConfigureAwait(false);
                return;
            }

            throw new NotSupportedException("Could not find suitable method to upload submodel element on ISubmodelClient");
        }

        public async Task<object?> InvokeOperationAsync(string operationId, params object[] inputs)
        {
            var clientType = _submodelClient.GetType();
            var method = clientType.GetMethod("InvokeOperationAsync");
            if (method == null) throw new NotSupportedException("InvokeOperationAsync not available on ISubmodelClient");

            var invocationRequestType = Type.GetType("BaSyx.Models.AdminShell.InvocationRequest, BaSyx.Models")
                ?? Type.GetType("BaSyx.Models.AdminShell.InvocationRequest, BaSyx.Models.AdminShell");

            object? invocationRequest = null;
            if (invocationRequestType != null)
            {
                invocationRequest = Activator.CreateInstance(invocationRequestType);
                var inputsProp = invocationRequestType.GetProperty("Inputs");
                if (inputsProp != null)
                {
                    var listType = typeof(System.Collections.Generic.List<object>);
                    var list = Activator.CreateInstance(listType) as System.Collections.IList;
                    if (list != null)
                    {
                        foreach (var i in inputs) list.Add(i);
                        inputsProp.SetValue(invocationRequest, list);
                    }
                }
            }

            var taskObj = method.Invoke(_submodelClient, new object[] { operationId, invocationRequest, true });
            if (taskObj is Task task)
            {
                await task.ConfigureAwait(false);
                var resultProp = task.GetType().GetProperty("Result");
                return resultProp?.GetValue(task);
            }

            return null;
        }
    }
}
