using System;
using System.Reflection;
using System.Threading.Tasks;
using BaSyx.API.Clients;
using BaSyx.Models.AdminShell;
using AasSharpClient.Adapters;

namespace AasSharpClient.Adapters
{
    // Adapter that delegates operations to BaSyx ISubmodelClient / IAssetAdministrationShellClient
    public class BasyxAdapter : IBasyxAdapter
    {
        private readonly ISubmodelClient _submodelClient;
        private readonly IAssetAdministrationShellClient? _aasClient;

        public BasyxAdapter(ISubmodelClient submodelClient, IAssetAdministrationShellClient? aasClient = null)
        {
            _submodelClient = submodelClient ?? throw new ArgumentNullException(nameof(submodelClient));
            _aasClient = aasClient;
        }

        public async Task UploadPropertyAsync<T>(ISubmodelElement parent, string propertyName, T value)
        {
            if (parent == null) throw new ArgumentNullException(nameof(parent));

            string idShortPath = parent.IdShort + "/" + propertyName;

            // Build a PropertyValue wrapper using the SDK helper types via reflection
            Type? propertyValueType = Type.GetType("BaSyx.Models.AdminShell.PropertyValue, BaSyx.Models")
                ?? Type.GetType("BaSyx.Models.AdminShell.PropertyValue, BaSyx.Models.AdminShell");

            object? propertyValue = null;
            if (propertyValueType != null)
            {
                // try to find a constructor that accepts an IValue
                var ctor = propertyValueType.GetConstructors(BindingFlags.Public | BindingFlags.Instance)
                    .FirstOrDefault(c => c.GetParameters().Length == 1);
                if (ctor != null)
                {
                    // try to create IValue wrapper from the raw value via simple string conversion fallback
                    // This is best-effort and may need domain-specific mapping per property type.
                    propertyValue = Activator.CreateInstance(propertyValueType, new object[] { value?.ToString() });
                }
            }

            var clientType = _submodelClient.GetType();
            var method = clientType.GetMethod("UpdateSubmodelElementValueAsync", BindingFlags.Public | BindingFlags.Instance);
            if (method == null) throw new NotSupportedException("ISubmodelClient.UpdateSubmodelElementValueAsync not found");

            var taskObj = method.Invoke(_submodelClient, new object[] { idShortPath, propertyValue ?? (object)value });
            if (taskObj is Task task)
            {
                await task.ConfigureAwait(false);
            }
        }

        public async Task UploadElementAsync(ISubmodelElement element)
        {
            if (element == null) throw new ArgumentNullException(nameof(element));

            await _submodelClient.UpdateSubmodelElementAsync(".", element).ConfigureAwait(false);
        }

        public async Task<object?> InvokeOperationAsync(string operationId, params object[] inputs)
        {
            // Use concrete InvocationRequest type from the SDK
            Type? invocationRequestType = Type.GetType("BaSyx.Models.AdminShell.InvocationRequest, BaSyx.Models")
                ?? Type.GetType("BaSyx.Models.AdminShell.InvocationRequest, BaSyx.Models.AdminShell");

            object? invocationRequest = null;
            if (invocationRequestType != null)
            {
                // choose constructor with requestId or default
                var ctor = invocationRequestType.GetConstructor(new Type[] { typeof(string) });
                if (ctor != null)
                    invocationRequest = ctor.Invoke(new object[] { Guid.NewGuid().ToString() });
                else
                    invocationRequest = Activator.CreateInstance(invocationRequestType);

                var inputsProp = invocationRequestType.GetProperty("Inputs");
                if (inputsProp != null)
                {
                    var listType = typeof(System.Collections.Generic.List<object>);
                    var list = Activator.CreateInstance(listType) as System.Collections.IList;
                    if (list != null)
                    {
                        foreach (var i in inputs) list.Add(i);
                        inputsProp.SetValue(invocationRequest, list);
                    }
                }
            }

            var result = await _submodelClient.InvokeOperationAsync(operationId, invocationRequest, true).ConfigureAwait(false);
            return result;
        }
    }
}
