using System;
using System.Reflection;
using System.Threading.Tasks;
using BaSyx.API.Clients;
using BaSyx.Models.AdminShell;
using BaSyx.Models.AdminShell.Value;
using AasSharpClient.Adapters;

namespace AasSharpClient.Adapters
{
    // Adapter that delegates operations to BaSyx ISubmodelClient / IAssetAdministrationShellClient
    public class BasyxAdapter : IBasyxAdapter
    {
        private readonly ISubmodelClient _submodelClient;
        private readonly IAssetAdministrationShellClient? _aasClient;

        public BasyxAdapter(ISubmodelClient submodelClient, IAssetAdministrationShellClient? aasClient = null)
        {
            _submodelClient = submodelClient ?? throw new ArgumentNullException(nameof(submodelClient));
            _aasClient = aasClient;
        }

        public async Task UploadPropertyAsync<T>(ISubmodel parent, string propertyName, T value)
        {
            if (parent == null) throw new ArgumentNullException(nameof(parent));

            // parent may be a Submodel itself, so we need to build idShortPath
            string idShortPath = propertyName;
            if (!string.IsNullOrEmpty(parent.IdShort))
            {
                idShortPath = parent.IdShort + "/" + propertyName;
            }

            var valueScope = new ValueScope();
            // ValueScope has Value property of type PropertyValue
            valueScope.Value = new PropertyValue { Value = value?.ToString() };

            await _submodelClient.UpdateSubmodelElementValueAsync(idShortPath, valueScope).ConfigureAwait(false);
        }

        public async Task UploadElementAsync(ISubmodelElement element)
        {
            if (element == null) throw new ArgumentNullException(nameof(element));

            await _submodelClient.UpdateSubmodelElementAsync(".", element).ConfigureAwait(false);
        }

        public async Task<object?> InvokeOperationAsync(string operationId, params object[] inputs)
        {
            var invocationRequest = new InvocationRequest();
            invocationRequest.Inputs = new System.Collections.Generic.List<object>(inputs);

            var result = await _submodelClient.InvokeOperationAsync(operationId, invocationRequest, true).ConfigureAwait(false);
            return result;
        }
    }
}
