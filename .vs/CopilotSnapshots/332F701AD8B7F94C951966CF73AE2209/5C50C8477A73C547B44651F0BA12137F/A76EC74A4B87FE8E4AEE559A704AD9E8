using System.Collections.Generic;
using System.Threading.Tasks;
using BaSyx.Models.AdminShell;
using BaSyx.Models.Extensions;
using AasSharpClient.Adapters;
using AasSharpClient.Tools;
using System.Text.Json;
using BaSyx.Utils.Client.Http;
using BaSyx.Utils.DependencyInjection;
using BaSyx.Utils;

namespace AasSharpClient.Models
{
    // Generated POCO for ProductionPlan submodel using BaSyx models
    public partial class ProductionPlan
    {
        public ISubmodelElementCollection Content { get; set; } = new SubmodelElementCollection("ProductionPlan");

        public IProperty IsFinished => BasyxBrowser.FindProperty(Content, "IsFinished");

        public List<Step> Steps { get; set; } = new();

        [System.Text.Json.Serialization.JsonIgnore]
        public IBasyxAdapter? Adapter { get; set; }

        public ProductionPlan() { }

        // Domain-friendly constructor used by tests
        public ProductionPlan(bool isFinished, int totalPieces, Step initialStep)
        {
            Content = new SubmodelElementCollection("ProductionPlan");
            Content.Value.Value.Add(new Property<string>("IsFinished", isFinished.ToString()));
            Content.Value.Value.Add(new SubmodelElementCollection("Steps") { Value = { Value = { initialStep.Content } } });
            Steps.Add(initialStep);
        }

        public async Task<bool> IsFinishedAsync()
        {
            var val = await BasyxBrowser.GetPropertyValueAsStringAsync(IsFinished).ConfigureAwait(false);
            return bool.TryParse(val, out var v);
        }

        public async Task CompleteAsync()
        {
            await BasyxBrowser.SetPropertyValueAsync(IsFinished, "true").ConfigureAwait(false);
            if (Adapter != null)
            {
                await Adapter.UploadPropertyAsync(this.Content, IsFinished.IdShort, "true").ConfigureAwait(false);
            }
        }

        public async Task UploadStepAsync(Step step)
        {
            if (Adapter != null)
            {
                await Adapter.UploadElementAsync(step.Content).ConfigureAwait(false);
            }
        }

        public void append_step(Step step)
        {
            // add to inner Steps collection and to Steps list
            var coll = new SubmodelElementCollection("Steps");
            coll.Value.Value.Add(step.Content);
            Content.Value.Value.Add(coll);
            Steps.Add(step);
        }

        public async Task<string> ToJsonAsync()
        {
            // Build a BaSyx Submodel and serialize it using the official BaSyx serializer options
            var submodel = new Submodel(Content.IdShort, new BaSyxSubmodelIdentifier(Content.IdShort, "1.0.0"));

            var elements = new ElementContainer<ISubmodelElement>();
            foreach (var el in BasyxBrowser.GetElements(Content))
            {
                elements.Add(el);
            }
            submodel.SubmodelElements = elements;

            var options = new DefaultJsonSerializerOptions();
            var services = DefaultImplementation.GetStandardServiceCollection();
            options.AddDependencyInjection(new DependencyInjectionExtension(services));
            options.AddFullSubmodelElementConverter();
            var jsonOptions = options.Build();

            var json = JsonSerializer.Serialize(submodel, jsonOptions);
            return await Task.FromResult(json).ConfigureAwait(false);
        }

        public static ProductionPlan Parse(string json)
        {
            // very small parser for the tests: parse JSON and reconstruct ProductionPlan
            var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;
            var elements = root.GetProperty("submodelElements").EnumerateArray();
            var isFinished = false;
            Step firstStep = null;
            foreach (var el in elements)
            {
                var id = el.GetProperty("idShort").GetString();
                if (id == "IsFinished")
                {
                    var val = el.GetProperty("value").GetString();
                    isFinished = bool.TryParse(val, out var v) && v;
                }
                if (id == "Steps")
                {
                    var stepsArr = el.GetProperty("value").EnumerateArray();
                    foreach (var s in stepsArr)
                    {
                        var stepElems = s.GetProperty("value").EnumerateArray();
                        var title = "";
                        var status = "";
                        foreach (var se in stepElems)
                        {
                            var sid = se.GetProperty("idShort").GetString();
                            if (sid == "StepTitle") title = se.GetProperty("value").GetString();
                            if (sid == "Status") status = se.GetProperty("value").GetString();
                        }
                        var action = new Action("Action0001", "Imported", ActionStatusEnum.OPEN, new InputParameters(new Dictionary<string,string>()), new FinalResultData(), new SkillReference(new Dictionary<object,string>()), "");
                        firstStep = new Step("Step0001", title, status == "DONE" ? StepStatusEnum.DONE : StepStatusEnum.OPEN, action, "", null, "", "");
                    }
                }
            }

            return new ProductionPlan(isFinished ? true : false, 0, firstStep);
        }
    }
}
